// Dynamic approach - analyzes all columns automatically
// Step 1: Get the total table size first
let TotalTableSize = toscalar(
    CommonSecurityLog
    | where TimeGenerated > ago(30d)
    | summarize sum(estimate_data_size(*))
);

// Step 2: Get all column names from the table schema
let ColumnList = 
    CommonSecurityLog
    | getschema
    | where ColumnName != ""
    | project ColumnName
    | summarize make_list(ColumnName);

// Step 3: Create a union of all column size calculations
union (
    // For each major column type, calculate its size
    CommonSecurityLog
    | where TimeGenerated > ago(30d)
    | extend ColumnName = "TimeGenerated", ColumnSize = estimate_data_size(TimeGenerated)
    | summarize TotalColumnSize = sum(ColumnSize) by ColumnName
),
(
    CommonSecurityLog
    | where TimeGenerated > ago(30d)
    | extend ColumnName = "DeviceVendor", ColumnSize = estimate_data_size(DeviceVendor)
    | summarize TotalColumnSize = sum(ColumnSize) by ColumnName
),
(
    CommonSecurityLog
    | where TimeGenerated > ago(30d)
    | extend ColumnName = "DeviceProduct", ColumnSize = estimate_data_size(DeviceProduct)
    | summarize TotalColumnSize = sum(ColumnSize) by ColumnName
),
(
    CommonSecurityLog
    | where TimeGenerated > ago(30d)
    | extend ColumnName = "Activity", ColumnSize = estimate_data_size(Activity)
    | summarize TotalColumnSize = sum(ColumnSize) by ColumnName
),
(
    CommonSecurityLog
    | where TimeGenerated > ago(30d)
    | extend ColumnName = "LogSeverity", ColumnSize = estimate_data_size(LogSeverity)
    | summarize TotalColumnSize = sum(ColumnSize) by ColumnName
),
(
    CommonSecurityLog
    | where TimeGenerated > ago(30d)
    | extend ColumnName = "Protocol", ColumnSize = estimate_data_size(Protocol)
    | summarize TotalColumnSize = sum(ColumnSize) by ColumnName
),
(
    CommonSecurityLog
    | where TimeGenerated > ago(30d)
    | extend ColumnName = "SourceIP", ColumnSize = estimate_data_size(SourceIP)
    | summarize TotalColumnSize = sum(ColumnSize) by ColumnName
),
(
    CommonSecurityLog
    | where TimeGenerated > ago(30d)
    | extend ColumnName = "DestinationIP", ColumnSize = estimate_data_size(DestinationIP)
    | summarize TotalColumnSize = sum(ColumnSize) by ColumnName
),
(
    CommonSecurityLog
    | where TimeGenerated > ago(30d)
    | extend ColumnName = "SourcePort", ColumnSize = estimate_data_size(SourcePort)
    | summarize TotalColumnSize = sum(ColumnSize) by ColumnName
),
(
    CommonSecurityLog
    | where TimeGenerated > ago(30d)
    | extend ColumnName = "DestinationPort", ColumnSize = estimate_data_size(DestinationPort)
    | summarize TotalColumnSize = sum(ColumnSize) by ColumnName
)
// Add more union blocks for other columns as needed
| extend TotalTableSize = TotalTableSize
| extend ColumnSizeGB = format_bytes(TotalColumnSize, 2, "GB")
| extend TotalTableSizeGB = format_bytes(TotalTableSize, 2, "GB")
| extend ColumnPercentage = round((todouble(TotalColumnSize) / todouble(TotalTableSize)) * 100.0, 2)
| project ColumnName, ColumnSizeGB, ColumnPercentage, TotalTableSizeGB
| sort by ColumnPercentage desc